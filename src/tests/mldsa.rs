// Copyright 2025 Simo Sorce
// See LICENSE.txt file for terms

use crate::tests::*;

use serial_test::parallel;

#[test]
#[parallel]
fn test_mldsa_operations() {
    let mut testtokn = TestToken::initialized("test_mldsa_operations", None);

    let session = testtokn.get_session(true);

    /* login */
    testtokn.login();

    /* First test from:
     * https://github.com/usnistgov/ACVP-Server/blob/master/gen-val/json-files/ML-DSA-sigGen-FIPS204/internalProjection.json
     */

    let msg = hex::decode(
        "1E5A78AD64DF229AA22FD794EC0E82D0F69953118C09D134DFA20F1CC64A3671\
         DDA292BFD9AC708D156639FFD63844C793D849C7743B4FB1195259D46D3801DB\
         2EADCD31D515A93F60C84CDCBAEB8739777C54C826651FAAD368D582EBD05562\
         42F4EA5D71BB44E8A06F2C94E52319EED545A4C29A44D0190A3FED19FD49AE8C\
         5C32FFD4DA5C7E1C3FEE0CF67E2AE9C082D2CC9A5DB29441C9C4B9F0D883D6AC\
         65AABECFE49CC1A1DF01752F8699DDC42FC59DD4F614371B02E3709BFE5D1EB4\
         1D92905CEE18861FA7C3AE94CD97253A60B84EF638F43FF507ADE86ABB69658D\
         9643C6ABD33E7C7DBBD5C9350A3EC8EA4E2C0463EBB4F8E43D639B6B9642F571\
         F9B8D295817367651B39AA30D97D59A2187EACB1DA5E4669D9471E3BA498B766\
         06A2B363E0E068FADDDFC1311DD12C5C9E3F044DA9FB13AC1CB376EA6E4444DD\
         6BC80205D9F8E11DCB56ACED0A621C50328D7FE975222F08A78D5CC2FE34508A\
         CCCB9439225EE91E29796FD804BB397875741EBFCF11A8FF022463C3170A963B\
         2EB1A943DB91C5514C4FFB1E22312D0B5073CD94707F3B760F6FCBE7AF366E24\
         98920A32C68AEC42098F3E0B87B86FCE0B12F9852F2ECE38E36FCDC7D4CEE08B\
         5A83D791FF391E4AF9FCC33EB81FE5DD36A0B58FC1C8A76F240A6BE4D4E53FCD\
         CDF62A6D96A56EC1A2BA4ED69EF2424E54A2AC139CAE8184F06D376EFAC00547\
         D26131FA6D3A80E3B4513E434D98DC5C7866A5DA2C112FFFF197A816892213E0\
         FE9B6E7A4FBBB4F97CD925CBAD731C9883C0910EA103E341DC80B52234FCBCD9\
         1DEBB66A315F1D097447DD10520B7FA7BADC1245FC30CCB4059FD96CC529415A\
         E978D62C1BD77596068E3E6EB8E9E0B5EC7B4C7557A651F317D241A6F52398B3\
         B596F933C06B22065169EB4E23E4874646CF905DDCF7F0E3AB96983EDDC7FFF2\
         DC62523F2F27847CD8286C4789FD8AB0101E6DF516741608D5295A45E8FB2FBE\
         B1754CAE949765B3C4A6D1F3FFC60C06DC81390D86B1672810E6D695DA4923AA\
         1C6C0D95046631492CF3A67D9D26EEACBF358F0CA54B2BBF0A5014C6E092A76B\
         246F1AED72CB3C6C8DDE58B170727925ACB72782B54819365A806040D3BF2885\
         A517F0164C9B63E6B84454BE81853F6B90E88508174C8314856689D6B2F4B0E2\
         9DDA36B0DD090D32BF3ECF385C9E9CE356133484A2C55FDCC8CD205ACE232587\
         7DB15D1E69967EC56C28CD76284BE2A5C157F9D87C2E94FBF8A0465CCE795A8D\
         B5F8833F445E3B4FEBB0B236C0587C0E2AEED428B1DB8001F1A27CA4E56A761E\
         5E8ECEA5590D949580AAB3FC2F859D75442CC64498B91C849DDD4CD9F3BBFA9E\
         ADE1BC5DCDC03AF1336CE2CD5F1DDE3D7B7060E00823001AEC9C6594FEC80262\
         7712190EC318E6A40CCF6898D4082103714AA1F61D72B0C6EF7F76B36546C09C\
         05B6D5802050881C667D52B9EAEF9A6250CBDBBE6407184D923A5E4B354C225E\
         8852886E6A71CE4C0905FE36BF43014ECAAB0087A548EE8D2440F2EE9C912264\
         B412FCEB3D650D5152800752953D8D8428FBDD57B1D671853DC6D378C321CD10\
         5893734DC82A49A803B25E17CD2B53F8B8B50F6AA27BF82860C515870D1104B1\
         97D57EE835463A38657FD3AAFFD14A524DE089C8D265E5D77BA9930362AE28D6\
         5C5DE8187EA0D9417EE2CF885273D1F3C8773635E7610F80EDFC890E88B81B35\
         08251DD0C512CA83167129E2E5D3D304B71CBB7EE330FC7A2EAD2A4824EFB3A7\
         C5B45B2678891084F61A66E4DB3E2D1744ADFE3B60E0E9644C9559D596C09D7C\
         55052012EB18B1B6571C5ECD9548108882C008C16C09ADE6C7473E2A3F67A054\
         E7FB2DECC6B0D84D6F6A440EC6B1AB8AC0993D3615857883F1E7C3C46621209C\
         2A257F40D3D021BFF71E47E58C9FCD8B0BA54B6003CB79673C00BCE770D06CB7\
         4FD0AD943CB7300BF940018EECB583AECF3494D2D8706CD8B9BBF803DB1A00F9\
         AC349A0F4D9CBFA07723D070A332223404980271CA18EBEAE0FB30FB57A72FC9\
         B1A4C10FE98846D1A55FEBC35A4DD3EAB750AB0BE4B19E6E438398946E64FF63\
         E72BBD761DD984AFA3E62369872F6D788F9F60570B17F46E1BDEE96E38EAB8C8\
         C873F3C8C5628917A7B622D920B94D2DF2D07E272CC8D6DBF383D9A7F12C66C6\
         BF4322D55C60480EC78C20E1F2E8F1F485DA9B9EB0780BEB4850290E7150A4C7\
         9714C112AED3088D6E2F9F38B31E2B1C924AF895F4FEDB8155D1A964EEB73D66\
         C5D3001D05833E7D70909C8BF961BCF1B517C6AEB76A9B9832C795EC51781E0B\
         BB999A6F10E03458F8AFFF90960D49EBBEFADD0CC2F8FF604310FD3ADC372D70\
         203299424C7AEC922488A7B7CADFA92F0171247FE83E3D54DCE6EAFC7258E1A0\
         66C96F3F3D4A5CE279C54B004DDC462D0D7092BDD794398F72D78DA95C66586F\
         89F593110DB79F942FFC1322CEB02B69904762CBC86A95FADA7CF6DDDE8CDE8D\
         E819B17945D775703B5B276D8E140C69B46C353AF340893A6FD9E88227DBEF57\
         69A237DA19E0D6C582560B51A504D3C3FE1EB8CEE3482F1FF4CB5A1C9CF7C647\
         ACCD7262D80A876D3A188223607D05C9F58579EE229C24DC040FE5A14D10DE04\
         796CCFAACEC948770CDA6A0724342FDA6CA72D7BFB40B37B77402B20829448A5\
         20A7578F5872702200752ED6179B1D302F683695B6FFACD0FC271C3EEB48EC3B\
         B182A341655E42A33CE37AA811B0A3947F17696FD0F927C3E8BDEE9A15AD057B\
         1D3F86BB2F9D4898D7078EDDC2958EEBC132ECF1C40A7B373DD3DEAEF719AACB\
         C03D3D9F9B65C66C092D794B316596C76BE6B3C079C6B85BDE2220F60952C650\
         53BF42585CF9D175F265B87C655A5A5EC9E800BE69FD8B03969A986DDAB8D2C1\
         AADEA68BC360AF6CA41DBD04CA4EF5778FFBAFDB14712EF94B06B90C657693AF\
         6A82CB5AD1EA5A79C3152F98F6D70A4FA7FEE46E683D44763877761DD97381D3\
         B5B4DBD49D9C767469181859E76771C1249280E74A4964465769F7475EC491DC\
         6E16FF67982EE127E62EB7CD839BDF30BFD4E26A50EFEAB51C74037FC45CA221\
         E59CF4C697309506FCD0D734FE80BA5AE8BCA300E5767863DC97982E35DEF7BD\
         63B54D3EF6C7EC63D5C7E1C953C74DB5A2385DBC1905D632DAEB8E84946BCEDE\
         992AFC4B355D934578BD06BCA9534E6B1C2D9903BC91E85F01829C890D6521DB\
         838B1CA23269E23C3C194D0164D7B577759BE9B5465169B6CC2EB4179ACF5FC6\
         BF6B935FCAC40605E3E0552647B58DB59A36596C2BE04617EAE766396FC51C91\
         3F95B7F28D50AECF0815968D68539E326823DDB7619F5B765D21AF79930F1B79\
         6DBD79E5E8F5D978EEBB0C8756A4389960F9488A3F8A4FB97B9FE866C89C8A14\
         9CED32A0ECFE2CB0AE1C42B059D715468777151D24B766A05E66E414A6879430\
         6C655E6CEBC01076176C41A52BAE2060B38FEE5DCDF77AFB591D61FD75431DF0\
         C26D5E7937C9D576D4E2149EB2C0BDBF645A57C477579ECBDE9636C036E5592C\
         0BF465E86D84BA0B5365B46BC2599190DE97E3CE6F29E42756CCFDF1D429DB89\
         4ED7F844509B574828C6ED5C7EF498DC880AE9126FA7030339B584C5CCE3D240\
         C233605A36199AC8AA5375722C1DDDDB92CAD5A6699EBCAE322E5DEB63019B9E\
         391A7A5CCF2AA75DB153B02C55353196A1E8C768820B5A3C8F3085DD774C1B5A\
         7FCBA85EB47EC3593357B2C4DA4CDEB70BD5377F5C1A6AE1782FDB9384DAB563\
         178A7834ED3D6CD8682383ECEDD36B6AC309B72CAF33E5F700959B20572C7CB6\
         449F9745B7A2C1C301E7B341126A77144F32BF0190F903AFD02FD6AE006DBF1B\
         65955764E7BB9D830A4826B3E2B627D7439C8E1647E14B9C037F015426CB0B27\
         9A96F73942BAB0DE4907E3DC96062ED184FD7A0C955AB15CCF991E9899E68BED\
         24BCB91187ABD4BDA92371F93E1B3622179A3AB1B930E454A77FE516775A01BA\
         0021F7CC29456CBEAE333C79AE59DCB5B096F29BA08C0F1B89E357F46A83F1E6\
         9C1F521AD0E6B90A35DB3DC94B6D37FE73509968409EDA533CC7B3E24FA29AEC\
         FC88E6E6574F054AFF32397ADF4CE33CC6A796056FED6E8205AA6AD530B83C6F\
         561C152EA9FEA50A550856AE20DFFDA79DE49B8C11F00911B790E4FD5A5A5256\
         E15A5ADDF380216234A8F578FF2613EAA8C430830E1EC9B0FA08AECB60DAB24B\
         8155D533CAA66CCD68AAABDBA1031A665B44D80CA6D4ABB78E2483604D890CDF\
         83977B198D6E2E80D1D658BAD557D57E68FC546CB936E3FD6F62A2F9263DA4C0\
         65813377818363B0B1914289D11B19301DAA9DF24A7261B70FFD9CF01EE01214\
         6029D5EF88F32906EE9FDF1AEDF2FA0C53C0D9395205E93B71BB6BAB89524F90\
         AC2F7BCB276DF1F7E4F0F734ADD2737AA826426D70BE43DCF5FD5D7AEA0DF6E5\
         D38CED606CA333952E4AF896E1DF38CE3656B88037221D9A90E86F5A022041DC\
         86D813E6A0A9D061A77A908E58D4C46457609A2CE97CBEE6738E093D04DA10BF\
         D8516AA643902ED082A1FDF60890289925743513DF192DF07E5676CF795202A5\
         70991E816DEAD88C737945166D3D3DE95D828F07808158F6D2D7911C1DA14AC7\
         B86A33457A861CB57BB5943710FFC70F739470C31ABB10A4DE9807899F544107\
         B05616344DB07DCE46AAC29025378FD96130705FA8FA1ECE9F81F5F854625F3E\
         45B96EA0D92840E3F319BE3889B025D4915CECFF9287C01FF6EF5D8E9371E805\
         E24C404B0B20364D3002E6691A14BDFD0F89693D67418A86047AC10F7671E6D9\
         83D84C47AD355EFA9954411C0DC599B7FED4FF794A6CDD2F93EE80691BCFA171\
         1FF32FB3CBBCD10E03B3A945711E7485E4DCDF17E206CCB38C18037F4361AE43\
         99B23B814A7D94DDECE17F171F6948976EC4CBC9133B235B757A30609ABDF082\
         CAC9AFB9B5E249AFA6F2530661422EBD789D3D34E4790C486BF164932C3ACF3F\
         E7E0594D26C035ABF8AF421F848F4CD90E5D9A69FDD8632417D67AEB8D415EE9\
         12D795AD1B3C1A13073A0C489D241FE6DCF2D58B23E1167D8E748A41D43DE505\
         F7E044A37528CBE4E8BE4B1356F298A1174E28734756C9567A0BD5E72002D153\
         4E633A36C5373404661CE1ED379189635BAA44A6903468311609DAAA2C3100C9\
         AB83A5DF55F44C5CF4B9A8AF87DF5F55B6021821CC7DD7F3428F2A129329BD0E\
         CC69CC97E63F6574CC10236828AAC1401C6DD4EA3FCC32781B8C1EBB68186C18\
         21D05A49207CC28AEC58EEFEF5F380604B932B0042DFDE26B2EC14A9CA51CDBA\
         0F195BA80B0CD4476D16C91EF3E5652F35E90D36D37C317C786656F4C330A1B5\
         77E1E45A22B54A58C9FE7C735B568D09E0D8DA6B07449BF4737E5D55659D46EA\
         89257480EE46071055147A6E70A5FAD6BCBB910A1B2BDAEB62D2A02AC69F6D44\
         6DED18562C49C572E2F597E230FDC714A824F4D2E1B3D8A27BA1C9B4B8E905EC\
         F7AA6C37B9A3FAB18E73BDF3CD568D2C875914CC8B64EED925D1F926FA53E69F\
         E96538BD294E6EBDF08036D08CFD7475C8C4079F89EF522F6896852760EA31C5\
         444AF142CB55F08FF89DBBDD94576FABF95A112C192AE9DAA704131ADD665AAB\
         5ECB27FCA96DCFD9F021C972C9F9337CB0638EBB958F906B469AB09B2FE1B0C2\
         1084D7C8D3200E8715A7BCA9963075589F43FB8D286A303593FB1DB8F5E580AC\
         CA5FA23F51D3BFACF0B725C5C523676452A580B08E7B22B2C4299B93CCFF3E3B\
         6C81CDFD94C8FD1FF489084B1DF45E2E8EEAB73420ED2E975D37074FF3B435F9\
         0243BA2452F54E0ADAA09EBC127FEACB798E4702F9417E26A51FF3E3D2D8C092\
         461BCA08C0D7BDD6EDB0759E14D3B7501BDA28B4467C14CC4B7AFC0FCB3BBB50\
         3FB390C9CF06A5A1428E7E0E0DCAA1A12EBF1F8D280045D6E59A0E667900646B\
         BE8368B575E50F3B6750B48C52FA665AE0750F2FA779D3A86806AFDF410DF1F7\
         1AD108742481173DEEC707FBA8AEDC94794F736AF77E3DC6F78C378C23FE026F\
         4B5D3A2F8FDFAA54E007AEE540CA35A093D3DD437D3D5555019754CED5F7459D\
         AC47C5DE4E6F675693F0A84CD33E5E4B5B0D84689BAFB7113B899FF7363D4588\
         5381249F1590AD173B79F2344F91DEA18E8B0B1A7F991ED1E7DB6EFC87A3D086\
         25F8DDB2DFECD667280301BA809EEDAA86269A07C36A803133048CECF7D51A3D\
         3372D23D3B65C72992CF8500CA52D573C866D2A2E103F9F7351917A7166836AD\
         04CC0C5511B51159C87B0ABC61B54B4AABA2542E831F0940C8E3F24DBE90A49C\
         8CE6B6169D81151C9555C1EA43C1DB2767D537BA05C394BAE3AAD626D2A6AF8A\
         664E7E3CDDB320E35D59F117DAEDEA9F0AC5F46D1A0BEB0A2394C9BD65727687\
         6D9BD82E60E5ED5B4252C6F0CEB74FAC673B98482D1C263E7CDE21CA0E633623\
         4AC0CF299952DBA20E2189404A67E9455FD8219B96C0473DC571803B88FB7DCC\
         921057B7FDAE8489D72E097459EBB0FC1AA9C68B2FC934A178CCD81EDBB2D117\
         96E32CFA6403EF25635064CA62BF0A9D8F5BEE591214B0BF0BBCBBECD3E8DA3C\
         F96B34638940580803D9A0E0883F5D34B9AC06B5EFCB83CB47B53ABD0BF3FE03\
         31ED09C0F3C3499611DD2596DFF8754679C7DFD2EC0B2A032C2727D3D76AE528\
         6F7FD8FD85D7FB997EF3C019CEAFF36F891227F11B6E830AEB8F97EF5CC88AD2\
         F6F346D267FE58A0B8FB406F151593C417849B613CDB1CB5523FFBDE78B494BE\
         63D62E61740AF3247363CC3723D549E76E10A3F187EDA82455BADD5A22CB0485\
         3364455FFC01D4BB76224EE40071702F9A1EA97C3AC823A8352A6248C56946C1\
         47CDA99404E305188CDEB9AA95DD4FB703A2C3698D4C52DCF84A42021961992F\
         CCE4C2502973D25E8837C8",
    )
    .expect("failed to decode test message");

    let pk = hex::decode(
        "4A1FDEB2951D9D10C0330A420DFDCE3D52CD7BDD2DBCBF9BC0EAB1C0078C6CEA\
         68CEAF48C8A355F82987011F37B785F6C8DF1A5314F692C2682C27BDF91B711B\
         A7D65FBB18A1C2F2D40FFE2F3A52F3C1943E314C1279D3A8605EA6E06936B65C\
         FC2B71BDB36AD0ABCCC06C0561121C5BCE8649CDE0AE4B58E3F018627F1FFFC9\
         F34868693766B8FF457A0F4771D38412DD8DA9BE2C57CF35D74CF690B3141CC6\
         813BDD3F8158D2C83CEC1E1280A8E1B96BE6E82C6D26D45A4BFF5A898839E4D3\
         83111DFE2EA23340BF4BECC60D479CE75C5B17FE9A958867307FC49CA9E48AEC\
         8FFB2D2CB82D4804CB0593984D7A337B691B1C612E3638F71F5C008BF4E4C35F\
         199EA806FD8CF90F0C68D0D3B93F85C7F1A02FCDF2E01D8F46CFF49286744327\
         8E3CB9FEECF941B688705150C8352D894B81F6D566595DE69C3424EADF63CFA0\
         9623F6FD121A19C594888388AC88C948989A977227671DBDDF6C509A08960499\
         ECB2FCC156896570B7CF9B8612B800B11261E9B180CEF423646A3F716E410D02\
         1B7BECD0F9CFC8B5CD04D4D1482E5F51D9DE67390B523B39340534A041402EED\
         413B654EB48A05EE557AAAB7E41F6510DCD1B2F7AF142FDB2603127878BBB298\
         2453398E5788571F167F37FC1371F6809637B320567E129778CEC532F24A6625\
         F84A89E4AE578CBB15E4DF8F271DFDA2D56024994B5FCFD1F3C3843DD416D7A8\
         205116165B51D700B209AE84DC01E232CDA5E7558B8144226E2723B3618B639F\
         A522CA280F1D99510C1293A9FFB8ED14CDBE45DE61D0042FBCF15A60CB6950D8\
         0B62168A6C1CCAF5791A992494F4892C4BC2D1BF6DA3FFA300D4C315169DE895\
         5BF98AE633C3492C4C07A6857B188F7B75C1DB62382AF7EBA062663F08D1AB4E\
         A92584DD5F297FE7EB3F548D0D01C431945791AD216E0C1DA753317F22F20C54\
         26CFAE640F27E1B0AA7E775BE8FB1085A8C68948A1DC7F04A5CA45A58B7D0223\
         528C209F7D6040702CE58E5C0C7E54825A8C2B22FF3A08F3E26A858E1776B6C0\
         CE0A1580F2149A45BD8D956E8C9BBF18CF5F39723EF72B9EEEB7305853AB0BFC\
         CC49B4B501DD61125AB7159B435D607F72DD8C0292318433FAF1D94701A8F438\
         CBB9C3F46A152B3FC6B19633B4B55B1F619B0BA2FDE2457E7A9549F6EDF7A5D2\
         5947C372F63FF5352B66BA8F707055F1B617CB511377CC010737B223AF8F5BF2\
         6329C32033343CC971EE11F27E4CBCBE93F534646FEAD4A77EF1036DA8A0A337\
         CF36B93FC9BC77002D110A23C9E85120F658A3F93DCF8043A9B7A01AC11323AE\
         FA2E9EB4259FDC7A53BD763BCCF74E34378B6ACF78DE1FCF5731F1EBBE7735F9\
         26296BBD5B742DB88AC8476A9EC3B40E21F0DC204AAAB5FEDEF58F9C356C7CE3\
         FFB46220A67D648B52C37412790336F42861D5235637EC2B5392CE072760DADF\
         EF9902747018EC3EF231553833D0268D9025A316684CA2C40E4BD31BEEB88D99\
         F752249EB0DA18A2E6CA40E81853AFC86E76A64C01CC4975E8B0AEAA44AE18F6\
         5D7052399561CA774222DEF6BC8D49FF8C4837CBD2B9FD75EAAEC0211B1D9684\
         B8A820B947E1A5D1B101186BDFF9B56C6D220D489D997F7959046A36E9C7879C\
         AAB38573F1A8D11E080DE5947886C7C0637575A208C6C3D22B3E0CFB7659216C\
         2575D11780824E4522EC3C021AA65B70DE831485E3BA3AB01E51A15C1AF6C44B\
         8FBCC1531E6F5323DE2F9BB4E61D8222FAF2C837556887E7F2337604C8006B55\
         2E31D94EF9A5CE8409A5C425EEAE1361901C9558B3FB18F0F6490EEF98AFBA99\
         0E59F66A49BE91C0437616B132869B10FE542A0ADC52F2CE266E566DA4A0F0BE",
    )
    .expect("failed to decode ML-DSA public key");
    let pub_handle = ret_or_panic!(import_object(
        session,
        CKO_PUBLIC_KEY,
        &[
            (CKA_KEY_TYPE, CKK_ML_DSA),
            (CKA_PARAMETER_SET, CKP_ML_DSA_44),
        ],
        &[
            (CKA_VALUE, &pk),
            (CKA_LABEL, format!("ML-DSA public key").as_bytes()),
        ],
        &[(CKA_VERIFY, true)],
    ));

    let sk = hex::decode(
        "4A1FDEB2951D9D10C0330A420DFDCE3D52CD7BDD2DBCBF9BC0EAB1C0078C6CEA\
         272C272BE86D2DEC0E3FF6F37562CF37E09E5DAA586E16D0F7715B2A58369028\
         454D95EDDF28B43E2453CB72FC2F2528EEF36A5BC2F4446E6FD66357AA23CAF0\
         B96FBD3621DC9A5CB08ED975F6FCE317F4C0129ED8A40A6B287F357805A4A59D\
         1818621188411CA051C880201B406D04B9100AB74814B865C9181198A6850905\
         418B36405A1664A20651D8C884E012918CB8048A1246420052D080844A1408DC\
         A20118C52D1C000288460953A4705A060D9B346D5A020842326002C9490C058E\
         0B215253C48DDA480692A46118B8090332100A886910B36C52303119332CCCC6\
         0922852CD900291B206253886D58B2298B162C580472E3486803160113B60820\
         3629E2A045643600602206D3144E21234D1BA1841B882594B02DE2800CA10082\
         02272D54A46819092C13A52DA2A29090B64548146C82B66480A645C2A42C6304\
         01A0822112142EC1848D400402583621E4C68854482211C31102192A0B480C1A\
         077140288C98C88CE3488050802C443862A3062C19190909420E9818061C260C\
         D1046EDC0086C2C27019462A02A6818B046994B60D1883880C336182B08824B8\
         0562420608A508CA1668A28665118900144529D124321CC7491B818853842008\
         1421C2120E20814D13A32D63A621022809E02212A426245A982503114A92006D\
         A24080D08400C0048488B411D8A821E4280613204C53C01188348844464D8C02\
         28D8126C0CB4618C148693468D249805E3000CE0A4089836724A424408236C23\
         488D410650E142889A1602C4B8809210800C0980D3C8802496800C052DA3A824\
         23092412003141442DDCC051A2486501492DD2A0698C460254426148106C9A14\
         1040C68903180EDC20869B422E24328414838501244A54C80544C0905BC0301C\
         0870A0C86D53C2600203721A1529D1203082B6491A0764C2984D4C022CDA1852\
         59260C59A2510309110224320B43848A460899126910382A22C86D4B28722223\
         6A53A02DC0304DA0404801314222078984981149202DC81872143730DB040E21\
         3409DA247014976993C629A32800133489230184A4A661D83884C1324082162A\
         4AB80D001385E2162A08B2441113651099654CC2110187415A20258AC0080028\
         069C18650A2652E20205E294285B226E41A620DA344A20C0081B8311A3902464\
         880C63C044D9424DE4C46082002E8B3004024720583806E2186C94482D213412\
         8FE073A549F6DB81A91321F8632104342EAD4553868063EFCB6662F6C5AA267E\
         FA06030CE1549E3FEA3A2D3F88A308C3A3525462FF1DDB1F406EAF108A17D657\
         E361BDF2E5CB1F5A0F32249AFA265174E0232331EA5461ED08BD5BE1C4DE04B0\
         C14BDB9974190259E48C98BE014353804EF603BCFC6EBE44BD7B31770300BFED\
         F2B12E975953D8264D3DFFEFABB131637A218518A44B420B1EE26932D547099F\
         CE3D709F63F88A5C104D0823F84E1E497D50AFEA60DE0011CFA452EC468A7D5F\
         9D8B8CBDA58828FAE5198A0D65710D989FE23297157988EF01D2FAAC7D18525B\
         5D7307BA7D51191B409A9529BC79DF18BB6E8A099F149096AEFBBDDCB8DBD99F\
         44E37BDAB4A71B7806896DD330D9DB1139100167A660FE142A7DE42B1FD4A165\
         F759DD3B6A39676B23D297C926CF08420AC5550EE35CCCED8336FBA48686F295\
         3454FB01DAE8F19F09DAF7BF0E77B999F0734A6606C4850CD23C8B8C3C236559\
         B4C77FC97071C8D42480F2AB705DC8316D0586C7889AD600B142861CCA6EE240\
         5C02E8211BBEB22BA65AC926D0D1A4ED2AAE50925EC4E7074817DCADEB490026\
         8F775E9B03B237275FC7C2D75A79B31980147F9BBBB4ABC43E3FDC990B7D3FFC\
         E160BC426C5A303B8E3960472D35478BF1F669891181A3CD4117A67433C73A24\
         CBD830760986D2425F14FE4BB5803DD4F3437CF39D189E8E8E7F571B29812C5D\
         98CC359AC6ADAC4229B952C9E554A1488475D05C90F53D59FBF82E458830040B\
         12CCA0D446E707018DD83C54BD86277FCA93B0E0B1B18374014F8FFC319E712A\
         808F4B6F5E7A51B2B1E2D66591FEA6B3A765B9849060F02C3391F40E3F455DDB\
         82F4EFA8056736874D32D310699ABAAAC219105BB46FD5EEA2F7BD857CC64E9B\
         9E57BAC0994082E572CCBDB6C75923A6C8346D635A683A23C5539C93C1016DDB\
         A53BB1553AB38169638CD1926D714609570C6BE0811765544D508D5E4095E7B5\
         4FFFA44253C21EEBBAB5FBD0B6915ABED9B4EFA41C4025BC1FCEAD8F70037B14\
         09496BC6FD61A7FE74EDB29FC3768314452308A44761D84AB8F412D94BC9F435\
         1601D4D46186B52B550A242725E5247A9C4E9FFD44E0045BB41003FDFF4D5DD0\
         E56AB4CC6BEAAF807BC453AB2477828D64B49C598C04C4DC9BBD9E042A948242\
         4B58D8EF276D1CA26504943AD45947929F228E381E8ED1740DE279942B044BC4\
         480B28AF4E98FAB5B871C3FC7B8F2FDAE91973BFB55208FD2984E4EB40C59506\
         72EB257EA2053B28780DAFBD0525572343E473EDAA7133A84D98A55474D26E3A\
         35A6FC27C112061F1128DD9189E08F4C948F5597D643A269C646575545419011\
         9579B46603A56404FB4DC690FB874CCE7C55A48F382B8C00942C8BE164D184A8\
         229A8B278AB5D8320AB84BD56A2F1AAB6AA0DD364598324CA8480A550125BCB7\
         34180833BFAE1858AE2B18AD8C930B3E1D69553616AFFBE73EF40EE1089C0034\
         F7110492888B035674A3581EA997F70C00DDE17CD83CA22936BFA14E4190F09E\
         08AA8B30FE6F9CA273A584C0424DBFD9230FD0D6050B2E95D6C6C0C3B7485757\
         5F995AC02837D849718A15B7842F43D20BA7262B55B2A07EE265380250831678\
         140AE95A548908B3C656A6230293BE54ABCCBFB39A05441CAD1F22E4FF4F32B2\
         3FAA6F4306B10B2B38D54DEE3F7B1962338C077B693D15A8B43D043EC8342A48\
         2514FAD2708F3ADE1EC013AA01B6410DA5C61382372A38FC736B58D99DC5C1C5\
         406F3B019D3740BEBAE743BA83F747640BED829E99C2EB6EAA7329EC74757FF5\
         8979897B5C13630A3ABAEC5327A1E886028B43B5BD8C445746FE8A5FBCF09C70\
         D6FFE64D818B711DA11B68F0A36240BE0E5973D5195C93E5F53217A69E19CC2A\
         325167DF459514BB14536A30DA77DFA1F306792F10464DD3EC3E5EB67AEF7ECB\
         34DC239E2103663E7AD9FADBDA255325854288CF46E8B3925C2648DC752E3963\
         CC817FA8C57DAF22F960A63CD1DC11C20C311BCDAEAA98372E33CBF9C3222D26\
         1D7D32D4B7A4BBFD5C8EBA1EAD68A8A13C8DCDA04749FEC65A8FF54EE86D56DB\
         3A568F008DA5516B62EB896A701AAE16C319CA2104B95149AB3717E6FECE7A8C\
         E3CF0D802F4A8F22B14F3E7BFD33DBC430F5D7D7A55544889025D8362BEE465D\
         59E908345E6A041FA5C09045131327D1C4F92DE0BB40184225EA9EABE8BC5D3F\
         991FB9DEA9442A69879679C637C77797BFCA279FCC83841351B9C57BE70B5C09\
         C73F046CF1195FF1B2C95DA7E5BCDCF46BDECBA894A275D5BC70C14F4CF0A7A9\
         626CBE322887FC7980EECAE142BFD31016F60F5F42D34C76A362E8E191ED7981",
    )
    .expect("failed to decode ML-DSA private key");
    let priv_handle = ret_or_panic!(import_object(
        session,
        CKO_PRIVATE_KEY,
        &[
            (CKA_KEY_TYPE, CKK_ML_DSA),
            (CKA_PARAMETER_SET, CKP_ML_DSA_44),
        ],
        &[
            (CKA_VALUE, &sk),
            (CKA_LABEL, format!("ML-DSA private key").as_bytes()),
        ],
        &[(CKA_SIGN, true)],
    ));

    let context = hex::decode(
        "FDE19259E56C2602F3CB0DA509B912F88262A1701D4E02B513F45C97EBB100A1\
         7B208205098D6BED2638BEBDCDC52C4C5114E8CC8FD9A180E79CE750594C3BB1\
         88DB6A3605630C6A2F3049BECEE951FB45B5E426",
    )
    .expect("failed to decode Context String");

    let signature = hex::decode(
        "A4E46D38AB1867BCDB21153C516FCBAA68875303ED438451E1F04597CE6E6B36\
         3B0CF32EB6EDFB3031E2611DF8B6549C04350795C0562F5ABA84B3081102F769\
         D9AC2C01CF594AE408B5165197FC44AF951C0F82D5652E3A020D7CFDB970F4AC\
         A2236FFF136CCE66401F063ADBDDD84839B56BC82FBF5CAFECA8FB055DDCC597\
         F7E0E444AB3EDF5688827AA5E109386EDFBB4479803A30D2523F0BBDE033134B\
         77127BC5427310018B59E0F93812BF0EEF4EC37A77F73D0AD3E4CDC455021532\
         0C2C562E9DDFDFA3181029BFA46FD112AB4D1FA4CD0B9699B88F1BFBA2B00F0D\
         330C6067B248028051EE7631609FCB2BC71573086F5DB99673C4318ADF875794\
         1B0E7117C4BC2D047D5174E3A0E1E5CEC4EC2E29B9F617A2E75A910415433994\
         77A07F24ADBA9F786E8040A30BFFBA0103C9331D790B1629886E94D535D3DFF0\
         43A89D5D9A5A6867920C31A94BBA0C3BCC473112087D31A54534CC772EC29106\
         FAE39608F333238E74E18791227A475B7238B2F310AE5F1E196A3B14261C97F9\
         5355541AC56CE398F38535965C09708EEB7FCD23FE79B3E76FE4DE388B83AD13\
         064F9AD4469AD85655AD3790B958F7B5D82269EBD2E06C343F7207F96CD16B72\
         00150BBD327DD9B3405D58DD063193BA5B1648C8B4997BDD65271E782D286810\
         9AFB01D30A4BA8720DA3E447B426B33C1CD94BDE859D18613D234C74A4790E23\
         A174BC8CAEE8EADB19A9DAC27D340E62D8C2B3DF5D0D2147C4EA61078C9E4A2B\
         3B1F9D0EEE979154E798547CDE291DB46D257228BE695D99C7F27356EF0C9095\
         73E989F555214C32C82C0251497B92935121CF1D921B0251025C56C7B1224AB1\
         8D19C6233D5B232D13763794B74F43801BF4BB85380E804AE931AD473B3D51DA\
         4AF202C46EEA5E21259F31B732BAADC74C5E90F388DC121247EB447AC71504F4\
         83A7FBDEB5C3B6DDC6FEA607F3EB771026DDFB1756B1FB5F3DDF8AC834FD948C\
         67F533244E8E6C9F574803E4029155B321ED4B54E1BFED00BD91FF596261F876\
         756FBBC16EA125BE4D18ADF7B30D9DAD1A050D1B6804E6E5C88CCCAC2B3221BA\
         2C0422B5575829A16A68D4192BE785C5AE609BF3AB68133A499BB0C3A112F391\
         F47F3BA6828A37E6A5F776C5D45901660AE80FA23DA12C70E3BA88846864856F\
         7C9E1EE0CBA22C1E48ACDAC8CC1E17CFE1EF2F50A7211F18E19866E6735BD17A\
         F6696548C67CDAEC55A09951AB89426B54A2C4A9A60839D3C1B4B9FE26D9F53F\
         4DDC832E1399BC04E4F8A1C0AC4083A0281514693F32266632010F74C4B30250\
         0E6B8C5F2F99664D1E4D1408ED726A88E301EB9D3B5E0493D9B6FC1884BC753B\
         5D84B96B0E5F23E786DCA71D4EEA5A35F1748B4BAC9A43CE47A6FE073CEB1A57\
         A5BF8D24009D11019F5EB04D3C79DD948D55F7F16886679F6CA592566EA18C51\
         646F298722414C49164E27E85F94B1D4350799B6421BC179D7AC095652DBF6C7\
         5DBE4D2F4F831671E339941D1D21FE16BDA064C62859F5662139DF9C2F0B8A6F\
         2562D1C7F9A509845722E916FE4D67F7CAB6E1459356499AE7FF61C9729409D4\
         E1FD0731D69C2EEE5B7A4C5D85D2DA84984AFD6083C4794A837D0E1FD3283AEE\
         7AB12558B186015C108F364A7EF09DD207818000267C0C975664F990CB51D482\
         21AAEE94F5252FAD9E01652025F1678BE6044FAEBBA8E94DC43AF8902A5058CE\
         29D6E17325B1F13A0FB3EEFE46067EEE5BF8E462CB9B6B466B14C541BD211E62\
         60A31041C748EFDF1B35E75B0133E99283206344598ACEE2AD92519A90E99FD9\
         6DFEECB58BB40B2ADCA1B462E910D394181F9DF9B1D92686BA21E243DB7D8FE2\
         A0713D6CCCBC0328F3F9DBCB3037DCF9E811F8C25B0AB9E73D4BCF1335187A86\
         EE8911BB494B8F1B0228803EA37C8EFD3D947A08226F4A262984C20A9E58558E\
         6AE03FA694622A634594DB35CC41974DF43C12D042DD752EAE99F31D34BB52AE\
         D1DA0069568E1C7A1EE725A7AED750DE79D94D7AB75499019D6C2DDA120A1C6F\
         813AC008B16CAED0015AE609818FE7D8AD1EDD247DA3153EE3D9C8836C77EEC8\
         4B885F3856DFC304B57C67D930BCD6C77A29271F9035EA6212A9DCF5526DAF19\
         C47533BF80BB6D15ECB582A78A67BA92F5B413E17AE69C2EFF3BC2EBF5256E92\
         832130D3EC7F7AD76CC8C5DD59FC2EE9E0A7873806C152791741E6C6533F6368\
         506FC4A655A92CF77FC44BD4CE3A4480D588DCAB0C8B398AE8CA6A7DA65792C3\
         946102C45DF4C72EC9FAFF22430F131EDE726DC2987B4DABB72AFE5376A9798C\
         FF3E8758B3F7BB56692BCC4822CA337395B6C2540FE966A70AC469FF6DDF0909\
         AB83434C34A854381F5BADF46E4DB78A317E0BCA59A3A8C5972F8D059D7B3A51\
         470D560D3B47EBC7FA13A253662305B78F7A146FE86B4381B4EE360ADB027C96\
         46BBCEDEB03C959E4F3111B2F8434949CBF04CD487BBD100708F47C12715E4BC\
         9E9D87DA5717246E6F3E4354636CE312560673F4037E4651A2098553C64C11BC\
         FC9B881C7858583066D80353ABA92869BB20B75106C233619B95D7EC58630CC2\
         D4158650582C345D3C3110361DDE04B69F38175D136F1E28020D36D2D90F2853\
         748A232BAEEDEC38A739781BFB7F52154BA20DF52BEBA4CD65ABC7DC57EC4845\
         65186DAA795B42C8988293B2D4EF0524CBDE85143ADA3D1B28374D2B1A335C6A\
         914705CBC2E2DBA7D363ED78590369FF256B3BE230412E821407865A07D1DA11\
         7BAE75B0226D173C14B15B3E85AE50A569ABD465D4E4500FDF535BBC2C1C5AE9\
         C1CA73753CF488A9A4BB406549BD3BE25AFC62F7B70DFC2E940B8C37CF33D2F8\
         0AB3D1070B03617043BABF7D687CB04B33AAEE8005F58D06C4464440875A79AF\
         4F5079FFA1CCA1B109419223FF9E56674D834FBFDE69F406873C3E54218EFD8F\
         70D3DB7084AE9734E31906AD94491CE12B828CC785080DCC911ACF80C522817C\
         CAEF838BC50ECBB499F12ABF32647C425C7A432C0321F13EF4E18B628DC68D7B\
         D5D049592A73A96C2CC8F2D4924A1D14ABB2B15DB7BD5BD4A46B09FAFB0F8057\
         8C2B8D0F4767EE26AB05D22A3BF2F02FCDA404646495F27B2A4E6BFD33E73201\
         3DE703CAE16B45F9BC39BA8FA2EE8FF427DA4FAC6C822B905465014647873E1E\
         E8832A87870107B9856E950EEDC6FB097F5383DDF6E4AE01C98D5AC6054AB356\
         55318517E669E379140246AE63D52066037FF37B6814A911A15C0982140DC132\
         143F8707C04C6F81742872FA83E6CFA8112C644BC1A86162527F924D9DF22341\
         232E3540484956677D99D6DFFB055A7A7F8C9EAFB9BBC4C8D2D7DADEDFFA1B2B\
         476578798091B8B9E2F0F1FBFE090B2E47818CAECED6E0E9FC00000000000000\
         000000000000000000000000000000000D1E2D39",
    )
    .expect("failed to decode signature");

    let params = CK_SIGN_ADDITIONAL_CONTEXT {
        hedgeVariant: CKH_DETERMINISTIC_REQUIRED,
        pContext: byte_ptr!(context.as_ptr()),
        ulContextLen: context.len() as CK_ULONG,
    };

    let mechanism: CK_MECHANISM = CK_MECHANISM {
        mechanism: CKM_ML_DSA,
        pParameter: void_ptr!(&params),
        ulParameterLen: sizeof!(CK_SIGN_ADDITIONAL_CONTEXT),
    };

    let ret = sig_verify(
        session,
        pub_handle,
        msg.as_slice(),
        signature.as_slice(),
        &mechanism,
    );
    assert_eq!(ret, CKR_OK);

    let out = ret_or_panic!(sig_gen(
        session,
        priv_handle,
        msg.as_slice(),
        &mechanism
    ));
    assert_eq!(out, signature);

    /* re-test but using the C_VerifySignature API */
    let ret = sig_verifysig(
        session,
        pub_handle,
        msg.as_slice(),
        signature.as_slice(),
        &mechanism,
    );
    assert_eq!(ret, CKR_OK);
}
